name: 编译 AutoLoadLua DLL

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      
    - name: 设置 MSVC 环境 (x64)
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64
        
    - name: 编译 AutoLoadLua.dll (x64)
      shell: cmd
      run: |
        echo ========================================
        echo 编译 AutoLoadLua.dll (x64)
        echo ========================================
        echo 当前目录: %CD%
        echo.
        
        REM 直接使用 GitHub Actions 预装的 Visual Studio 路径
        set "VS_PATH=C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvarsall.bat"
        if not exist "%VS_PATH%" set "VS_PATH=C:\Program Files\Microsoft Visual Studio\2022\Professional\VC\Auxiliary\Build\vcvarsall.bat"
        if not exist "%VS_PATH%" set "VS_PATH=C:\Program Files\Microsoft Visual Studio\2022\Community\VC\Auxiliary\Build\vcvarsall.bat"
        if not exist "%VS_PATH%" set "VS_PATH=C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise\VC\Auxiliary\Build\vcvarsall.bat"
        if not exist "%VS_PATH%" set "VS_PATH=C:\Program Files (x86)\Microsoft Visual Studio\2019\Professional\VC\Auxiliary\Build\vcvarsall.bat"
        if not exist "%VS_PATH%" set "VS_PATH=C:\Program Files (x86)\Microsoft Visual Studio\2019\Community\VC\Auxiliary\Build\vcvarsall.bat"
        
        if not exist "%VS_PATH%" (
          echo [错误] 未找到 Visual Studio
          dir /b "C:\Program Files\Microsoft Visual Studio\" 2>nul
          exit /b 1
        )
        
        echo 找到 Visual Studio: %VS_PATH%
        call "%VS_PATH%" x64
        if %ERRORLEVEL% NEQ 0 (
          echo [错误] 设置编译环境失败
          exit /b 1
        )
        
        where cl >nul 2>&1
        if %ERRORLEVEL% NEQ 0 (
          echo [错误] 编译器设置失败
          exit /b 1
        )
        
        echo [OK] 编译环境设置成功
        echo.
        
        echo 正在编译 AutoLoadLua.dll...
        cl /LD /EHsc /O2 /W3 AutoLoadLua_Final.cpp /link /OUT:AutoLoadLua.dll kernel32.lib psapi.lib
        if %ERRORLEVEL% NEQ 0 (
          echo [错误] DLL 编译失败
          exit /b 1
        )
        
        if exist AutoLoadLua.dll (
          echo [成功] AutoLoadLua.dll 编译完成
          dir AutoLoadLua.dll
        ) else (
          echo [错误] AutoLoadLua.dll 文件不存在
          exit /b 1
        )
        
    - name: 编译 Injector.exe (x64)
      shell: cmd
      run: |
        echo ========================================
        echo 编译 Injector.exe (x64)
        echo ========================================
        echo.
        
        echo 正在编译 Injector.exe...
        cl /EHsc /O2 /W3 Injector.cpp /link /OUT:Injector.exe kernel32.lib
        if %ERRORLEVEL% NEQ 0 (
          echo [错误] Injector 编译失败
          exit /b 1
        )
        
        if exist Injector.exe (
          echo [成功] Injector.exe 编译完成
          dir Injector.exe
        ) else (
          echo [警告] Injector.exe 文件不存在
        )
        
    - name: 重命名 x64 文件
      shell: cmd
      run: |
        if exist AutoLoadLua.dll ren AutoLoadLua.dll AutoLoadLua_x64.dll
        if exist Injector.exe ren Injector.exe Injector_x64.exe
        
    - name: 设置 MSVC 环境 (x86)
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x86
        
    - name: 编译 AutoLoadLua.dll (x86)
      shell: cmd
      run: |
        echo ========================================
        echo 编译 AutoLoadLua.dll (x86)
        echo ========================================
        
        cl /LD /EHsc /O2 /W3 AutoLoadLua_Final.cpp /link /OUT:AutoLoadLua_x86.dll kernel32.lib psapi.lib
        if %ERRORLEVEL% NEQ 0 (
          echo [错误] DLL (x86) 编译失败
          exit /b 1
        )
        
        if exist AutoLoadLua_x86.dll (
          echo [成功] AutoLoadLua_x86.dll 编译完成
          dir AutoLoadLua_x86.dll
        ) else (
          echo [错误] AutoLoadLua_x86.dll 文件不存在
          exit /b 1
        )
        
    - name: 编译 Injector.exe (x86)
      shell: cmd
      run: |
        echo ========================================
        echo 编译 Injector.exe (x86)
        echo ========================================
        
        cl /EHsc /O2 /W3 Injector.cpp /link /OUT:Injector_x86.exe kernel32.lib
        if %ERRORLEVEL% NEQ 0 (
          echo [错误] Injector (x86) 编译失败
          exit /b 1
        )
        
        if exist Injector_x86.exe (
          echo [成功] Injector_x86.exe 编译完成
          dir Injector_x86.exe
        ) else (
          echo [警告] Injector_x86.exe 文件不存在
        )
        
    - name: 创建构建产物目录
      shell: cmd
      run: |
        if not exist "build_artifacts" mkdir build_artifacts
        if not exist "build_artifacts\x64" mkdir build_artifacts\x64
        if not exist "build_artifacts\x86" mkdir build_artifacts\x86
        
    - name: 复制编译产物
      shell: cmd
      run: |
        REM x64 版本
        if exist "AutoLoadLua_x64.dll" (
          copy "AutoLoadLua_x64.dll" "build_artifacts\x64\AutoLoadLua.dll"
          echo [OK] AutoLoadLua_x64.dll 已复制
        ) else (
          echo [错误] AutoLoadLua_x64.dll 不存在
          exit /b 1
        )
        
        if exist "Injector_x64.exe" (
          copy "Injector_x64.exe" "build_artifacts\x64\Injector.exe"
          echo [OK] Injector_x64.exe 已复制
        )
        
        REM x86 版本
        if exist "AutoLoadLua_x86.dll" (
          copy "AutoLoadLua_x86.dll" "build_artifacts\x86\AutoLoadLua.dll"
          echo [OK] AutoLoadLua_x86.dll 已复制
        ) else (
          echo [错误] AutoLoadLua_x86.dll 不存在
          exit /b 1
        )
        
        if exist "Injector_x86.exe" (
          copy "Injector_x86.exe" "build_artifacts\x86\Injector.exe"
          echo [OK] Injector_x86.exe 已复制
        )
        
    - name: 上传构建产物
      uses: actions/upload-artifact@v4
      with:
        name: AutoLoadLua-DLL
        path: build_artifacts/
        retention-days: 30
