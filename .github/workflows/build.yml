name: 编译 AutoLoadLua DLL

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      
    - name: 设置 MSVC 环境 (x64)
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64
        
    - name: Build AutoLoadLua.dll (x64)
      shell: cmd
      run: |
        echo ========================================
        echo Building AutoLoadLua.dll (x64)
        echo ========================================
        echo Current directory: %CD%
        echo.
        
        REM Use GitHub Actions pre-installed Visual Studio
        set "VS_PATH=C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvarsall.bat"
        if not exist "%VS_PATH%" set "VS_PATH=C:\Program Files\Microsoft Visual Studio\2022\Professional\VC\Auxiliary\Build\vcvarsall.bat"
        if not exist "%VS_PATH%" set "VS_PATH=C:\Program Files\Microsoft Visual Studio\2022\Community\VC\Auxiliary\Build\vcvarsall.bat"
        if not exist "%VS_PATH%" set "VS_PATH=C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise\VC\Auxiliary\Build\vcvarsall.bat"
        if not exist "%VS_PATH%" set "VS_PATH=C:\Program Files (x86)\Microsoft Visual Studio\2019\Professional\VC\Auxiliary\Build\vcvarsall.bat"
        if not exist "%VS_PATH%" set "VS_PATH=C:\Program Files (x86)\Microsoft Visual Studio\2019\Community\VC\Auxiliary\Build\vcvarsall.bat"
        
        if not exist "%VS_PATH%" (
          echo [ERROR] Visual Studio not found
          dir /b "C:\Program Files\Microsoft Visual Studio\" 2>nul
          exit /b 1
        )
        
        echo Found Visual Studio: %VS_PATH%
        call "%VS_PATH%" x64
        if %ERRORLEVEL% NEQ 0 (
          echo [ERROR] Failed to setup build environment
          exit /b 1
        )
        
        where cl >nul 2>&1
        if %ERRORLEVEL% NEQ 0 (
          echo [ERROR] Compiler not found
          exit /b 1
        )
        
        echo [OK] Build environment ready
        echo.
        
        echo Building AutoLoadLua.dll...
        cl /LD /EHsc /O2 /W3 AutoLoadLua_Final.cpp /link /OUT:AutoLoadLua.dll kernel32.lib psapi.lib
        if %ERRORLEVEL% NEQ 0 (
          echo [ERROR] Failed to build DLL
          exit /b 1
        )
        
        if exist AutoLoadLua.dll (
          echo [OK] AutoLoadLua.dll built successfully
          dir AutoLoadLua.dll
        ) else (
          echo [ERROR] AutoLoadLua.dll not found
          exit /b 1
        )
        
    - name: Build Injector.exe (x64)
      shell: cmd
      run: |
        echo ========================================
        echo Building Injector.exe (x64)
        echo ========================================
        echo.
        
        echo Building Injector.exe...
        cl /EHsc /O2 /W3 Injector.cpp /link /OUT:Injector.exe kernel32.lib
        if %ERRORLEVEL% NEQ 0 (
          echo [ERROR] Failed to build Injector
          exit /b 1
        )
        
        if exist Injector.exe (
          echo [OK] Injector.exe built successfully
          dir Injector.exe
        ) else (
          echo [WARN] Injector.exe not found
        )
        
    - name: 重命名 x64 文件
      shell: cmd
      run: |
        if exist AutoLoadLua.dll ren AutoLoadLua.dll AutoLoadLua_x64.dll
        if exist Injector.exe ren Injector.exe Injector_x64.exe
        
    - name: 设置 MSVC 环境 (x86)
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x86
        
    - name: Build AutoLoadLua.dll (x86)
      shell: cmd
      run: |
        echo ========================================
        echo Building AutoLoadLua.dll (x86)
        echo ========================================
        
        cl /LD /EHsc /O2 /W3 AutoLoadLua_Final.cpp /link /OUT:AutoLoadLua_x86.dll kernel32.lib psapi.lib
        if %ERRORLEVEL% NEQ 0 (
          echo [ERROR] Failed to build x86 DLL
          exit /b 1
        )
        
        if exist AutoLoadLua_x86.dll (
          echo [OK] AutoLoadLua_x86.dll built successfully
          dir AutoLoadLua_x86.dll
        ) else (
          echo [ERROR] AutoLoadLua_x86.dll not found
          exit /b 1
        )
        
    - name: Build Injector.exe (x86)
      shell: cmd
      run: |
        echo ========================================
        echo Building Injector.exe (x86)
        echo ========================================
        
        cl /EHsc /O2 /W3 Injector.cpp /link /OUT:Injector_x86.exe kernel32.lib
        if %ERRORLEVEL% NEQ 0 (
          echo [ERROR] Failed to build x86 Injector
          exit /b 1
        )
        
        if exist Injector_x86.exe (
          echo [OK] Injector_x86.exe built successfully
          dir Injector_x86.exe
        ) else (
          echo [WARN] Injector_x86.exe not found
        )
        
    - name: 创建构建产物目录
      shell: cmd
      run: |
        if not exist "build_artifacts" mkdir build_artifacts
        if not exist "build_artifacts\x64" mkdir build_artifacts\x64
        if not exist "build_artifacts\x86" mkdir build_artifacts\x86
        
    - name: 复制编译产物
      shell: cmd
      run: |
        REM x64 版本
        if exist "AutoLoadLua_x64.dll" (
          copy "AutoLoadLua_x64.dll" "build_artifacts\x64\AutoLoadLua.dll"
          echo [OK] AutoLoadLua_x64.dll 已复制
        ) else (
          echo [错误] AutoLoadLua_x64.dll 不存在
          exit /b 1
        )
        
        if exist "Injector_x64.exe" (
          copy "Injector_x64.exe" "build_artifacts\x64\Injector.exe"
          echo [OK] Injector_x64.exe 已复制
        )
        
        REM x86 版本
        if exist "AutoLoadLua_x86.dll" (
          copy "AutoLoadLua_x86.dll" "build_artifacts\x86\AutoLoadLua.dll"
          echo [OK] AutoLoadLua_x86.dll 已复制
        ) else (
          echo [错误] AutoLoadLua_x86.dll 不存在
          exit /b 1
        )
        
        if exist "Injector_x86.exe" (
          copy "Injector_x86.exe" "build_artifacts\x86\Injector.exe"
          echo [OK] Injector_x86.exe 已复制
        )
        
    - name: 上传构建产物
      uses: actions/upload-artifact@v4
      with:
        name: AutoLoadLua-DLL
        path: build_artifacts/
        retention-days: 30
